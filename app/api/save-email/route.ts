import { NextResponse } from "next/server";
import { connectToDatabase } from "@/lib/mongodb";
import { createTransport } from "nodemailer";

const transporter = createTransport({
  service: process.env.EMAIL_SERVICE,
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD,
  },
});

const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAYAAADL1t+KAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAE0GlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTA1LTE4PC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmEyNDJkZWQ0LTFkZjEtNGNjMi04Y2UwLTlhOTRlNzA3OWI4YTwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz52YWd1aW5oYXMgLSAxPC9yZGY6bGk+CiAgIDwvcmRmOkFsdD4KICA8L2RjOnRpdGxlPgogPC9yZGY6RGVzY3JpcHRpb24+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6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'

export async function POST(request: Request) {
  try {
    const { email } = await request.json();

    if (!email || typeof email !== "string") {
      return NextResponse.json(
        { message: "Email inválido" },
        { status: 400 }
      );
    }

    const { db } = await connectToDatabase();
    const normalizedEmail = email.toLowerCase();

    const existing = await db.collection("emails").findOne({ email: normalizedEmail });
    if (existing) {
      return NextResponse.json(
        { message: "Este e-mail já está cadastrado" },
        { status: 409 }
      );
    }

    await db.collection("emails").insertOne({
      email: normalizedEmail,
      createdAt: new Date(),
      confirmed: false,
    });

    const mailOptions = {
      from: `Vaguinhas <${process.env.EMAIL_FROM}>`,
      to: normalizedEmail,
      subject: "Confirmação de cadastro - vaguinhas",
      html: `
        <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
          <!-- Fallback table for email clients -->
          <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
            <tr>
              <td style="padding: 20px 0; text-align: center">
                <img src="cid:logo@vaguinhas" 
                     alt="Vaguinhas Logo" 
                     style="height: auto; width: 200px;"
                     width="200"
                     height="auto">
              </td>
            </tr>
          </table>
          <h1 style="color: #ff914d; font-size: 24px; margin-top: 0">Obrigado por se cadastrar!</h1>
          <p style="font-size: 16px; line-height: 1.5;">
            Você receberá vagas de tecnologia diariamente em seu e-mail.
          </p>
          <p style="font-size: 16px; line-height: 1.5;">
            Caso não tenha sido você, por favor ignore este e-mail.
          </p>
          <hr style="margin: 30px 0; border: 1px solid #e5e7eb;">
          <small style="color: #6b7280;">
            Equipe Vaguinhas
          </small>
        </div>
      `,
      attachments: [{
        filename: 'vaguinhas.png',
        content: LOGO_BASE64.split('base64,')[1],
        encoding: 'base64',
        cid: 'logo@vaguinhas'
      }]
    };

    await transporter.sendMail(mailOptions);

    return NextResponse.json({ message: "E-mail salvo e confirmação enviada" }, { status: 201 });
  } catch (error) {
    console.error("Error:", error);
 
    const errorMessage = error instanceof Error ? error.message : "Erro ao processar solicitação";
    
    return NextResponse.json(
      { message: errorMessage },
      { status: 500 }
    );
  }
}

export async function GET() {
  return NextResponse.json(
    { message: "Method not allowed" },
    { status: 405 }
  );
}